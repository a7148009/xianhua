<!-- pages/admin/user-management.wxml -->
<wxs module="utils" src="./user-management.wxs"></wxs>
<view class="container">
  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <view class="page-title">{{filterTitle}}</view>
    
    <!-- ç”¨æˆ·ç»Ÿè®¡åŒºåŸŸ -->
    <view class="stats-container">
      <view class="stats-title">ç”¨æˆ·ç»Ÿè®¡</view>
      <view class="stats-row">
        <view class="stat-item total" bindtap="onFilterByRole" data-role="all">
          <view class="stat-number">{{totalUsers}}</view>
          <view class="stat-label">æ€»ç”¨æˆ·</view>
        </view>
        <view class="stat-item admin" bindtap="onFilterByRole" data-role="admin">
          <view class="stat-number">{{adminCount}}</view>
          <view class="stat-label">ç®¡ç†å‘˜</view>
        </view>
        <view class="stat-item user" bindtap="onFilterByRole" data-role="user">
          <view class="stat-number">{{userCount}}</view>
          <view class="stat-label">æ™®é€šç”¨æˆ·</view>
        </view>
        <view class="stat-item vip" bindtap="onFilterByRole" data-role="vip">
          <view class="stat-number">{{vipCount}}</view>
          <view class="stat-label">VIPç”¨æˆ·</view>
        </view>
      </view>
    </view>
    
    <!-- æœç´¢åŒºåŸŸ -->
    <view class="search-container">
      <view class="search-input-wrapper">
        <input 
          class="search-input" 
          placeholder="æœç´¢ç”¨æˆ·" 
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="onSearch"
        />
      </view>
      <view class="search-buttons">
        <button class="search-btn" bindtap="onSearch">æœç´¢</button>
        <button class="clear-btn" bindtap="onClearSearch">æ¸…ç©º</button>
      </view>
    </view>

    <!-- ç”¨æˆ·åˆ—è¡¨ -->
    <view class="user-list">
      <view wx:for="{{userList}}" wx:key="openid" class="user-card">
        <view class="user-header">
          <view class="user-avatar-container">
            <image
              wx:if="{{item.avatarUrl && item.avatarUrl !== ''}}"
              class="user-avatar"
              src="{{item.avatarUrl}}"
              mode="aspectFill"
              binderror="onAvatarError"
              data-openid="{{item.openid}}"
              data-index="{{index}}"
              lazy-load="{{true}}"
            />
            <view wx:else class="avatar-placeholder">ğŸ‘¤</view>
          </view>
          <view class="user-basic-info">
            <view class="user-nickname">{{item.nickName || 'å¾®ä¿¡ç”¨æˆ·'}}</view>
            <view class="user-role-tag {{getRoleClass(item.role)}}">{{getRoleName(item.role)}}</view>
          </view>
        </view>

        <view class="user-details">
          <view class="detail-item">
            <text class="detail-label">OpenID:</text>
            <text class="detail-value openid-value-full">{{item.openid}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">VIPåˆ°æœŸ:</text>
            <text class="detail-value vip-expire-value">{{utils.formatTime(item.vipExpireDate) || 'æ— '}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">æœ€è¿‘ç™»å½•:</text>
            <text class="detail-value login-time-value">{{utils.formatTime(item.loginTime) || 'æœªç™»å½•'}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">è®¢å•æ•°é‡:</text>
            <text class="detail-value order-count-value">{{item.orderCount || 0}}ç¬”</text>
          </view>
        </view>

        <view class="user-actions">
          <button class="action-btn copy-btn" bindtap="copyOpenid" data-openid="{{item.openid}}">
            å¤åˆ¶ID
          </button>
          <button class="action-btn setting-btn" bindtap="onUserSetting" data-user="{{item}}">
            ç”¨æˆ·è®¾ç½®
          </button>
          <button class="action-btn vip-btn" bindtap="onSetVip" data-user="{{item}}">
            è®¾ä¸ºVIP
          </button>
          <button class="action-btn order-btn" bindtap="onViewOrders" data-user="{{item}}">
            æŸ¥çœ‹è®¢å•
          </button>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ï¼ˆä¼˜åŒ–ï¼šé¦–æ¬¡åŠ è½½æ—¶ä¸æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{!initialLoading && !loading && userList.length === 0}}" class="empty-state">
      <text>æš‚æ— ç”¨æˆ·æ•°æ®</text>
    </view>

    <!-- åŠ è½½æ›´å¤šçŠ¶æ€ï¼ˆä»…åœ¨åŠ è½½æ›´å¤šæ—¶æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{loading && !initialLoading}}" class="loading-state">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view wx:if="{{!hasMore && userList.length > 0}}" class="no-more-state">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </view>

  <!-- ç”¨æˆ·è®¾ç½®å¼¹çª— -->
  <view wx:if="{{showUserSettingModal}}" class="modal-overlay" bindtap="onCancelUserSetting">
    <view class="modal" catchtap="">
      <view class="modal-header">
        <text class="modal-title">ç”¨æˆ·è®¾ç½®</text>
        <text class="close-btn" bindtap="onCancelUserSetting">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="user-preview">
          <image wx:if="{{selectedUser.avatarUrl}}" class="preview-avatar" src="{{selectedUser.avatarUrl}}" mode="aspectFill"></image>
          <view wx:else class="preview-avatar-placeholder">ğŸ‘¤</view>
          <view class="preview-info">
            <view class="preview-nickname">{{selectedUser.nickName || 'å¾®ä¿¡ç”¨æˆ·'}}</view>
            <view class="preview-role">å½“å‰è§’è‰²: <text class="role-highlight">{{getRoleName(selectedUser.role || 'user')}}</text></view>
            <view class="preview-openid">ç”¨æˆ·ID: {{selectedUser.openid}}</view>
          </view>
        </view>

        <view class="role-options">
          <text class="section-title">é€‰æ‹©è§’è‰²:</text>
          <view class="role-buttons">
            <button
              class="role-option-btn {{newRole === 'user' ? 'active' : ''}}"
              bindtap="selectRole"
              data-role="user"
            >
              æ™®é€šç”¨æˆ·
            </button>
            <button
              class="role-option-btn {{newRole === 'admin' ? 'active' : ''}}"
              bindtap="selectRole"
              data-role="admin"
            >
              ç®¡ç†å‘˜
            </button>
            <button
              class="role-option-btn {{newRole === 'publisher' ? 'active' : ''}}"
              bindtap="selectRole"
              data-role="publisher"
            >
              å‘å¸ƒè€…
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- VIPè®¾ç½®å¼¹çª— -->
  <view wx:if="{{showVipModal}}" class="modal-overlay" bindtap="onCancelVipSetting">
    <view class="modal" catchtap="">
      <view class="modal-header">
        <text class="modal-title">è®¾ç½®VIP</text>
        <text class="close-btn" bindtap="onCancelVipSetting">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="user-preview">
          <image wx:if="{{selectedUser.avatarUrl}}" class="preview-avatar" src="{{selectedUser.avatarUrl}}" mode="aspectFill"></image>
          <view wx:else class="preview-avatar-placeholder">ğŸ‘¤</view>
          <view class="preview-info">
            <view class="preview-nickname">{{selectedUser.nickName || 'å¾®ä¿¡ç”¨æˆ·'}}</view>
            <view class="preview-role">å½“å‰è§’è‰²: <text class="role-highlight">{{getRoleName(selectedUser.role || 'user')}}</text></view>
            <view class="preview-openid">ç”¨æˆ·ID: {{selectedUser.openid}}</view>
          </view>
        </view>

        <view class="vip-options">
          <text class="section-title">é€‰æ‹©VIPæ—¶é•¿:</text>
          <view class="vip-duration-buttons">
            <button
              class="vip-option-btn {{vipDuration === 1 ? 'active' : ''}}"
              bindtap="selectVipDuration"
              data-duration="1"
            >
              1ä¸ªæœˆ
            </button>
            <button
              class="vip-option-btn {{vipDuration === 3 ? 'active' : ''}}"
              bindtap="selectVipDuration"
              data-duration="3"
            >
              3ä¸ªæœˆ
            </button>
            <button
              class="vip-option-btn {{vipDuration === 6 ? 'active' : ''}}"
              bindtap="selectVipDuration"
              data-duration="6"
            >
              6ä¸ªæœˆ
            </button>
            <button
              class="vip-option-btn {{vipDuration === 12 ? 'active' : ''}}"
              bindtap="selectVipDuration"
              data-duration="12"
            >
              1å¹´
            </button>
          </view>
          <view wx:if="{{vipDuration}}" class="vip-expire-info">
            åˆ°æœŸæ—¶é—´: {{vipExpireTime}}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å¯¼èˆªæ  -->
  <cover-view class="tab-bar">
    <cover-view
      wx:for="{{tabBarList}}"
      wx:key="index"
      class="tab-bar-item {{tabBarSelected === index ? 'tab-bar-item-active' : ''}}"
      data-path="{{item.pagePath}}"
      data-index="{{index}}"
      bindtap="switchTab"
    >
      <cover-view class="tab-bar-icon">
        <cover-view
          class="icon-emoji"
          style="color: {{tabBarSelected === index ? tabBarSelectedColor : tabBarColor}}"
        >
          {{tabBarSelected === index ? item.selectedEmoji : item.emoji}}
        </cover-view>
      </cover-view>
      <cover-view
        class="tab-bar-text"
        style="color: {{tabBarSelected === index ? tabBarSelectedColor : tabBarColor}}"
      >
        {{item.text}}
      </cover-view>
    </cover-view>
  </cover-view>
</view>