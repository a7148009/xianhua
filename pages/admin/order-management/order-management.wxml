<!-- pages/admin/order-management.wxml -->
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">{{pageTitle}}</text>
  </view>

  <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
  <view class="stats-overview">
    <view class="stats-card">
      <view class="stat-item">
        <text class="stat-value">{{stats.totalOrders}}</text>
        <text class="stat-label">æ€»è®¢å•</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{stats.todayOrders}}</text>
        <text class="stat-label">ä»Šæ—¥è®¢å•</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">Â¥{{stats.totalRevenue}}</text>
        <text class="stat-label">æ€»æ”¶å…¥</text>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ -->
  <view class="filter-section">
    <view class="filter-tabs">
      <view
        class="filter-tab {{dateFilter === 'all' ? 'active' : ''}}"
        bindtap="onDateFilterChange"
        data-filter="all"
      >
        å…¨éƒ¨
      </view>
      <view
        class="filter-tab {{dateFilter === 'today' ? 'active' : ''}}"
        bindtap="onDateFilterChange"
        data-filter="today"
      >
        ä»Šæ—¥
      </view>
      <view
        class="filter-tab {{dateFilter === 'week' ? 'active' : ''}}"
        bindtap="onDateFilterChange"
        data-filter="week"
      >
        æœ¬å‘¨
      </view>
      <view
        class="filter-tab {{dateFilter === 'month' ? 'active' : ''}}"
        bindtap="onDateFilterChange"
        data-filter="month"
      >
        æœ¬æœˆ
      </view>
    </view>

    <!-- æœç´¢æ¡† -->
    <view class="search-box">
      <input
        class="search-input"
        placeholder="æœç´¢è®¢å•å·/ç”¨æˆ·æ˜µç§°/OpenID"
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
      <button class="search-btn" size="mini" bindtap="onSearch">æœç´¢</button>
      <button wx:if="{{searchKeyword}}" class="clear-btn" size="mini" bindtap="onClearSearch">æ¸…ç©º</button>
    </view>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view class="order-list">
    <view wx:if="{{loading && orderList.length === 0}}" class="loading-state">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <view wx:elif="{{orderList.length === 0}}" class="empty-state">
      <text>æš‚æ— è®¢å•æ•°æ®</text>
    </view>

    <view wx:else>
      <view
        wx:for="{{orderList}}"
        wx:key="_id"
        class="order-card"
        bindtap="onOrderDetail"
        data-order="{{item}}"
      >
        <!-- è®¢å•å¤´éƒ¨ -->
        <view class="order-header">
          <view class="order-no">
            <text class="label">è®¢å•å·ï¼š</text>
            <text class="value">{{item.order_no}}</text>
          </view>
          <view class="order-status {{item.status}}">
            {{item.status_text}}
          </view>
        </view>

        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <view class="order-user">
          <image
            wx:if="{{item.avatar_url}}"
            class="user-avatar"
            src="{{item.avatar_url}}"
            mode="aspectFill"
          />
          <view wx:else class="user-avatar-placeholder">ğŸ‘¤</view>
          <text class="user-nickname">{{item.nickname || 'å¾®ä¿¡ç”¨æˆ·'}}</text>
        </view>

        <!-- è®¢å•è¯¦æƒ… -->
        <view class="order-details">
          <view class="detail-row">
            <text class="detail-label">VIPæ—¶é•¿ï¼š</text>
            <text class="detail-value">{{item.vip_duration}}å¤©</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">æ”¯ä»˜é‡‘é¢ï¼š</text>
            <text class="detail-value amount">Â¥{{item.amount_yuan}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">æ”¯ä»˜æ—¶é—´ï¼š</text>
            <text class="detail-value">{{item.pay_time_str}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">VIPåˆ°æœŸï¼š</text>
            <text class="detail-value {{item.is_expired ? 'expired' : 'active'}}">
              {{item.vip_end_date_str}}
            </text>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="order-actions">
          <button
            class="action-btn detail-btn"
            catchtap="onOrderDetail"
            data-order="{{item}}"
          >
            æŸ¥çœ‹è¯¦æƒ…
          </button>
          <button
            wx:if="{{item.status === 'paid'}}"
            class="action-btn extend-btn"
            catchtap="onExtendVIP"
            data-order="{{item}}"
          >
            å»¶é•¿VIP
          </button>
          <button
            wx:if="{{item.status === 'paid'}}"
            class="action-btn refund-btn"
            catchtap="onRefund"
            data-order="{{item}}"
          >
            é€€æ¬¾
          </button>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{loading && orderList.length > 0}}" class="loading-more">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view wx:if="{{!hasMore && orderList.length > 0}}" class="no-more">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </view>

  <!-- å»¶é•¿VIPå¼¹çª— -->
  <view wx:if="{{showExtendModal}}" class="modal-overlay" bindtap="onCancelExtend">
    <view class="modal" catchtap="">
      <view class="modal-header">
        <text class="modal-title">å»¶é•¿VIP</text>
        <text class="close-btn" bindtap="onCancelExtend">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="extend-info">
          <view class="info-row">
            <text class="info-label">è®¢å•å·ï¼š</text>
            <text class="info-value">{{selectedOrder.order_no}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">ç”¨æˆ·ï¼š</text>
            <text class="info-value">{{selectedOrder.nickname}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">å½“å‰åˆ°æœŸï¼š</text>
            <text class="info-value">{{selectedOrder.vip_end_date_str}}</text>
          </view>
        </view>

        <view class="extend-input">
          <text class="input-label">å»¶é•¿å¤©æ•°ï¼š</text>
          <input
            class="days-input"
            type="number"
            placeholder="è¯·è¾“å…¥å¤©æ•°"
            value="{{extendDays}}"
            bindinput="onExtendDaysInput"
          />
          <text class="input-unit">å¤©</text>
        </view>
      </view>

      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="onCancelExtend">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="onConfirmExtend">ç¡®è®¤å»¶é•¿</button>
      </view>
    </view>
  </view>

  <!-- é€€æ¬¾å¼¹çª— -->
  <view wx:if="{{showRefundModal}}" class="modal-overlay" bindtap="onCancelRefund">
    <view class="modal" catchtap="">
      <view class="modal-header">
        <text class="modal-title">é€€æ¬¾ç¡®è®¤</text>
        <text class="close-btn" bindtap="onCancelRefund">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="refund-info">
          <view class="info-row">
            <text class="info-label">è®¢å•å·ï¼š</text>
            <text class="info-value">{{selectedOrder.order_no}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">ç”¨æˆ·ï¼š</text>
            <text class="info-value">{{selectedOrder.nickname}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">é‡‘é¢ï¼š</text>
            <text class="info-value amount">Â¥{{selectedOrder.amount_yuan}}</text>
          </view>
        </view>

        <view class="refund-input">
          <text class="input-label">é€€æ¬¾åŸå› ï¼š</text>
          <textarea
            class="reason-textarea"
            placeholder="è¯·è¾“å…¥é€€æ¬¾åŸå› "
            value="{{refundReason}}"
            bindinput="onRefundReasonInput"
            maxlength="200"
          />
        </view>

        <view class="refund-warning">
          <text>âš ï¸ é€€æ¬¾åå°†å–æ¶ˆç”¨æˆ·çš„VIPæƒé™ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</text>
        </view>
      </view>

      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="onCancelRefund">å–æ¶ˆ</button>
        <button class="modal-btn confirm danger" bindtap="onConfirmRefund">ç¡®è®¤é€€æ¬¾</button>
      </view>
    </view>
  </view>
</view>
